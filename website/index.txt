h1. Composite Primary Keys

h1. &#x2192; Ruby on Rails

h1. &#x2192; ActiveRecords

h2. What

Ruby on Rails does not support composite primary keys. This free software is an extension 
to the database layer of Rails - "ActiveRecords":http://wiki.rubyonrails.com/rails/pages/ActiveRecord - to support composite primary keys as transparently as possible.

Any Ruby script using ActiveRecords can use Composite Primary Keys with this library.

h2. Installing

<pre syntax="ruby">sudo gem install composite_primary_keys</pre>

Rails: Add the following to the bottom of your <code>environment.rb</code> file

<pre syntax="ruby">require 'composite_primary_keys'</pre>

Ruby scripts: Add the following to the top of your script

<pre syntax="ruby">require 'rubygems'
require 'composite_primary_keys'</pre>

h2. The basics

A model with composite primary keys would look like...

<pre syntax="ruby">class Membership < ActiveRecord::Base
  # set_primary_keys *keys - turns on composite key functionality
  set_primary_keys :user_id, :group_id
  belongs_to :user
  belongs_to :group
  has_many :statuses, :class => 'MembershipStatus', :foreign_key => [:user_id, :group_id]
end</pre>

A model associated with a composite key model would be defined like...

<pre syntax="ruby">class MembershipStatus < ActiveRecord::Base
  belongs_to :membership, :foreign_key => [:user_id, :group_id]
end</pre>

That is, associations can include composite keys too. Nice.

h2. Demonstration of usage

Once you've created your models to specify composite primary keys (such as the Membership class) and associations (such as MembershipStatus#membership), you can uses them like any normal model with associations.

But first, lets check out our primary keys.

<pre syntax="ruby">MembershipStatus.primary_key # => "id"    # normal single key
Membership.primary_key  # => [:user_id, :group_id] # composite keys
Membership.primary_key.to_s # => "user_id,group_id"</pre>

Now we want to be able to find instances using the same syntax we always use for ActiveRecords...

<pre syntax="ruby">MembershipStatus.find(1)    # single id returns single instance
=> <MembershipStatus:0x392a8c8 @attributes={"id"=>"1", "status"=>"Active"}>
Membership.find(1,1)  # composite ids returns single instance
=> <Membership:0x39218b0 @attributes={"user_id"=>"1", "group_id"=>"1"}></pre>

Using "Ruby on Rails":http://www.rubyonrails.org? You'll want to your url_for helpers
to convert composite keys into strings and back again...

<pre syntax="ruby">Membership.find(:first).to_param # => "1,1"</pre>

And then use the string id within your controller to find the object again

<pre syntax="ruby">params[:id] # => '1,1'
Membership.find(params[:id])
=> <Membership:0x3904288 @attributes={"user_id"=>"1", "group_id"=>"1"}></pre>

That is, an ActiveRecord supporting composite keys behaves transparently
throughout your application. Just like a normal ActiveRecord.


h2. Other tricks

Pass a list of composite ids to the <code>#find</code> method

<pre syntax="ruby">Membership.find [1,1], [2,1]
=> [
  <Membership:0x394ade8 @attributes={"user_id"=>"1", "group_id"=>"1"}>, 
  <Membership:0x394ada0 @attributes={"user_id"=>"2", "group_id"=>"1"}>
]</pre>

Perform <code>#count</code> operations

<pre syntax="ruby">MembershipStatus.find(:first).memberships.count # => 1</pre>

<a name="dbs"></a>

h2. Which databases?


A suite of unit tests have been run on the following databases:

|_.Database|_.Test Success|
|mysql     |<span class=success>YES</span>|
|oracle    |<span class=success>YES</span> (new 0.8.0)|
|sqlite3   |<span class=success>YES</span> (new 0.8.0)|
|postgresql|<span class=success>YES</span> (new 0.8.0)|
|firebird  |<span class=unknown>???</span> ("I can help":mailto:compositekeys@googlegroups.com)|
|sqlserver |<span class=unknown>???</span> ("I can help":mailto:compositekeys@googlegroups.com)|
|db2       |<span class=unknown>???</span> ("I can help":mailto:compositekeys@googlegroups.com)|
|sybase    |<span class=unknown>???</span> ("I can help":mailto:compositekeys@googlegroups.com)|
|openbase  |<span class=unknown>???</span> ("I can help":mailto:compositekeys@googlegroups.com)|
|frontbase |<span class=unknown>???</span> ("I can help":mailto:compositekeys@googlegroups.com)|

h2. Dr Nic's Blog

"http://www.drnicwilliams.com":http://www.drnicwilliams.com - for future announcements and
other stories and things.

h2. Forum

"http://groups.google.com/group/compositekeys":http://groups.google.com/group/compositekeys

h2. Licence

This code is free to use under the terms of the MIT licence. 

h2. Contact

Comments are welcome. Send an email to "Dr Nic Williams":mailto:drnicwilliams@gmail.com.
